version: 2.1

executors:
  macos_executor:
    macos:
      xcode: "15.3.0"
    resource_class: macos.m1.medium.gen1

commands:
  setup:
    steps:
      - restore_cache:
          key: v1-gems-{{ checksum "Gemfile.lock" }}
      - run:
          name: Install Gems
          command: bundle check || bundle install
      - save_cache:
          key: v1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
            
  store_scan_artifacts:
    steps:
      - store_artifacts:
          path: ~/Library/Logs/scan
          destination: scan-logs
  
  store_test_output:
    steps:
      - store_artifacts:
            path: "./fastlane/Test Output"
            destination: scan-test-output    
  
  store_scan_results:
    steps:
      - store_test_results:
            path: "./fastlane/Test Output"
  
  store_frameworks:
    steps:
      - store_artifacts:
            path: "./AppSizer/AppSizer/Frameworks/TwilioVerify.zip"

  configure_google_service_account:
    steps:
      - run:
          name: Configure Google Service Account
          command: echo $GCLOUD_SERVICE_KEY > gcloud-service-key.json

  configure_gcloud_app_distribution_service:
    steps:
      - run:
          name: Configure GCloud App Distribution service
          command: echo $GCLOUD_APP_DISTRIBUTION_SERVICE_KEY > ${HOME}/gcloud-app-distribution-service-key.json

  unit_tests:
    parameters:
      test_plan:
        type: string
    steps:
      - checkout
      - setup
      - setup-certificates
      - run:
          name: Unit Tests
          command: bundle exec fastlane unit_tests test_plan:<< parameters.test_plan >>
      - store_scan_artifacts
      - store_test_output
      - store_scan_results
      - cleanup-signing
  
  integration_tests:
    parameters:
      test_plan:
        type: string
      ftl_devices:
        type: string
        default: single
    steps:
      - checkout
      - setup
      - configure_google_service_account
      - run:
          name: Integration Tests
          command: bundle exec fastlane integration_tests test_plan:<< parameters.test_plan >> ftl_devices:<< parameters.ftl_devices >>
      - store_scan_artifacts

  build_framework:
    parameters:
      scheme:
        type: string
      artifact:
        type: string
    steps:
      - checkout
      - setup
      - run:
          name: "Build Universal Framework"
          command: bundle exec fastlane export_release_xcframework
      - run:
          name: "Zip Framework"
          command: |
                  cd Products/xcframeworks/release
                  zip -r ~/Desktop/<< parameters.artifact >>.framework.zip << parameters.artifact >>.xcframework
                  cp -r << parameters.artifact >>.xcframework ~/Desktop/
      - store_artifacts:
          path: ~/Desktop/<< parameters.artifact >>.framework.zip
          destination: << parameters.artifact >>.framework.zip
      - persist_to_workspace:
          root: ~/Desktop
          paths:
            - << parameters.artifact >>.framework.zip
            - << parameters.artifact >>.xcframework

  build_app_sizer:
    steps:
      - checkout
      - setup
      - attach_workspace:
          at: ~/Desktop
      - run:
          name: "Copy Frameworks"
          command: cp -a ~/Desktop/. ./AppSizer/AppSizer/Frameworks
      - run:
          ls -al ./AppSizer/AppSizer/Frameworks/
      - run:
          name: "Build AppSizer App"
          command: bundle exec fastlane build_app_sizer
      - run:
          name: "Copy Report"
          command: cp ./temp/SizeReport/SizeImpact.md ~/Desktop
      - store_artifacts:
          path: "./temp/SizeReport/TwilioVerify Size Impact Report.txt"
      - persist_to_workspace:
          root: ~/Desktop
          paths:
            - SizeImpact.md

  setup-certificates:
    steps:
      - run:
          name: Setup Certificate and Keychain
          command: |
            # create variables
            CERTIFICATE_PATH=$HOME/build_certificate.p12
            KEYCHAIN_PATH=$HOME/app-signing.keychain-db

            # import certificate from CircleCI context
            echo -n "$VERIFY_DEMO_CERT" | base64 --decode -o $CERTIFICATE_PATH

            # create temporary keychain
            security create-keychain -p "$KEYCHAIN_PASS" $KEYCHAIN_PATH
            security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
            security unlock-keychain -p "$KEYCHAIN_PASS" $KEYCHAIN_PATH

            # import certificate to keychain
            security import $CERTIFICATE_PATH -P "$VERIFY_DEMO_CERT_PASS" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
            security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASS" $KEYCHAIN_PATH
            security list-keychain -d user -s $KEYCHAIN_PATH
      - run:
          name: Setup Provisioning Profiles
          command: |
            setup_provisioning_profile() {
              local profile_var=$1
              local profile_path="$HOME/profile_$(basename "$profile_var").mobileprovision"

              # decode and save the provisioning profile
              echo -n "${!profile_var}" | base64 --decode -o "$profile_path"

              # create profiles directory if it doesn't exist
              mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

              # copy the profile to the correct location
              cp "$profile_path" ~/Library/MobileDevice/Provisioning\ Profiles/
            }
            setup_provisioning_profile "VERIFY_DEMO_PROFILE"
            setup_provisioning_profile "HOST_APP_PROFILE"
            setup_provisioning_profile "APP_SIZER_PROFILE"
  cleanup-signing:
    steps:
      - run:
          name: Clean Up Keychain and Provisioning Profile
          command: |
            security delete-keychain $HOME/app-signing.keychain-db || true
            rm -f ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision || true
  
  release:
    steps:
      - checkout
      - setup
      - setup-certificates
      - attach_workspace:
          at: ~/Desktop
      - configure_gcloud_app_distribution_service
      - run:
          name: "Release SDK"
          command: bundle exec fastlane release
      - cleanup-signing

  distribute_debug_sample_app:
    parameters:
      env:
        description: environment name (DEV, STAGE, PROD)
        type: string     
      base_url:
        description: API base URL
        type: string
    steps:
      - setup-certificates
      - run:
          name: Generating APK for internal distribution
          command: bundle exec fastlane distribute_debug_sample_app env:<<parameters.env>> url:<<parameters.base_url>>
      - cleanup-signing
jobs:
  Distribute debug sample app:
    executor: macos_executor
    steps:
      - checkout
      - setup
      - setup-certificates
      - configure_gcloud_app_distribution_service
      - distribute_debug_sample_app:
          env: "DEV"
          base_url: $DEV_URL
      - distribute_debug_sample_app:
          env: "STAGE"
          base_url: $STAGE_URL
      - distribute_debug_sample_app:
          env: "PROD"
          base_url: $PROD_URL
      - cleanup-signing

  Unit Tests and Lint:
    executor: macos_executor
    steps:
      - unit_tests:
          test_plan: CompleteSuite

  Integration Tests Single Device:
    executor: macos_executor
    steps:
      - setup-certificates
      - integration_tests:
          test_plan: IntegrationSuite
      - cleanup-signing

  Integration Tests All Devices:
    executor: macos_executor
    steps:
      - setup-certificates
      - integration_tests:
          test_plan: IntegrationSuite
          ftl_devices: all
      - cleanup-signing

  TwilioVerifyDemo Unit Tests:
    executor: macos_executor
    steps:
      - test:
          scheme: TwilioVerifyDemo

  Build TwilioVerify:
    executor: macos_executor
    steps:
      - build_framework:
          scheme: TwilioVerifySDK
          artifact: TwilioVerifySDK

  Size report:
    executor: macos_executor
    steps:
      - setup-certificates
      - build_app_sizer
      - cleanup-signing
  Release SDK:
    executor: macos_executor
    steps:
      - release
     
workflows:
  build_and_test:
    jobs:
      - Unit Tests and Lint:
          context:
            - verify-push-ios
      - Integration Tests Single Device:
          context:
            - verify-push-ios
          requires:
            - Unit Tests and Lint
      - Integration Tests All Devices:
          context:
            - verify-push-ios
          requires:
            - Integration Tests Single Device
      - Build TwilioVerify:
          context:
            - verify-push-ios
          requires:
            - Integration Tests Single Device
            - Unit Tests and Lint
      - Size report:
          context:
            - verify-push-ios
          requires:
            - Build TwilioVerify
      - Distribute debug sample app:
          context:
            - verify-push-ios
          requires:
           - Build TwilioVerify
          filters:
           branches:
             only:
               - /feature.*/
               - /release.*/
               - /hotfix.*/
               - dev
      - Release SDK:
          context:
            - verify-push-ios
          requires:
            - Size report
          filters:
            branches:
              only:
                - main
      # TODO: Enable this job when the target have tests otherwise the job will fail
      #- TwilioVerifyDemo Unit Tests
      # Uncomment this part when all the steps to release a new version are done      
